#!/usr/bin/env python3
import subprocess, os, json, sys

# --- CONFIGURATION & INTERNAL MENU ---
BASE_DIR = os.path.expanduser("~/.config/cmd-center")
CONFIG_PATH = os.path.join(BASE_DIR, "config.json")
STATE_PATH = os.path.join(BASE_DIR, "state.json")

# Define internal tools here for easy access
INTERNAL_MENU = {
    "üßπ Clear History": "INTERNAL:CLEAR_HIST",
    "üìù Edit Config": f"TERM:nano {CONFIG_PATH}" # Opens config in terminal editor
}

def load_data(path):
    if os.path.exists(path):
        with open(path, 'r') as f: return json.load(f)
    return {}

def save_data(path, data):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, 'w') as f: json.dump(data, f, indent=2)

def rofi_menu(options, prompt, theme):
    proc = subprocess.run(
        ["rofi", "-dmenu", "-i", "-p", prompt, "-theme-str", theme],
        input="\n".join(options), text=True, capture_output=True
    )
    return proc.stdout.strip()

def main():
    config = load_data(CONFIG_PATH)
    state = load_data(STATE_PATH)
    
    settings = config.get("settings", {})
    menu_data = config.get("menu", {})

    rem_path = settings.get("remember_last_path", True)
    rem_hist = settings.get("remember_history", True)

    current_path = state.get("last_path", []) if rem_path else []
    weights = state.get("history", {}) if rem_hist else {}

    while True:
        # Determine if we are navigating the internal options
        in_options = len(current_path) > 0 and current_path[0] == "‚öôÔ∏è Options"
        
        if in_options:
            active_menu = INTERNAL_MENU
        else:
            active_menu = menu_data
            try:
                for step in current_path: active_menu = active_menu[step]
            except: 
                current_path = []; active_menu = menu_data

        # 1. Prepare and Sort Items
        items = list(active_menu.keys())
        path_str = " > ".join(current_path)
        
        if rem_hist and not in_options:
            items.sort(key=lambda x: weights.get(f"{path_str}:{x}", 0), reverse=True)

        options = items.copy()
        
        # Keep Options at the very bottom of the main menu
        if not current_path:
            options.append("‚öôÔ∏è Options") 
        
        if len(current_path) >= 2: options.insert(0, "üè† HOME")
        if len(current_path) >= 1: options.insert(0, "‚¨ÖÔ∏è BACK")

        # 2. Show UI
        prompt = f" {settings.get('prompt_icon', '‚ö°')} " + (path_str if path_str else "MAIN")
        choice = rofi_menu(options, prompt, settings.get("theme", ""))

        if not choice: break

        # 3. Handle Navigation
        if choice == "‚¨ÖÔ∏è BACK":
            current_path.pop()
        elif choice == "üè† HOME":
            current_path = []
        elif choice == "‚öôÔ∏è Options":
            current_path = ["‚öôÔ∏è Options"]
        else:
            selection = active_menu.get(choice)
            
            # 4. Handle Internal Logic
            if selection == "INTERNAL:CLEAR_HIST":
                weights = {}
                state["history"] = {}
                save_data(STATE_PATH, state)
                subprocess.run(["notify-send", "Command Center", "History Cleared!"])
                current_path = []
                continue

            # 5. Regular Selection Logic
            if not in_options and rem_hist:
                weights[f"{path_str}:{choice}"] = weights.get(f"{path_str}:{choice}", 0) + 1
            
            state["last_path"] = current_path
            state["history"] = weights
            save_data(STATE_PATH, state)

            if isinstance(selection, dict):
                current_path.append(choice)
                continue 
            else:
                # 6. Execution Logic
                cmd = selection
                if cmd.startswith("TERM:"):
                    t = settings.get("terminal_emulator", "wezterm start --")
                    cmd = f"{t} bash -c \"{cmd[5:]}; echo; read\""
                elif cmd.startswith("WEB:"):
                    b = settings.get("browser", "xdg-open")
                    url = cmd[4:] if "://" in cmd[4:] else f"https://{cmd[4:]}"
                    cmd = f"{b} '{url}'"
                
                subprocess.Popen(cmd, shell=True, start_new_session=True)
                return 

        # Final state save for navigation
        state["last_path"] = current_path
        state["history"] = weights
        save_data(STATE_PATH, state)

if __name__ == "__main__":
    main()