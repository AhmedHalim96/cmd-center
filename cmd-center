#!/usr/bin/env python3
import subprocess, os, json, glob

# --- CONSTANTS & PATHS ---
BASE_DIR = os.path.expanduser("~/.config/cmd-center")
CONFIG_PATH = os.path.join(BASE_DIR, "config.json")
STATE_PATH = os.path.join(BASE_DIR, "state.json")

ICON_OPTIONS = "üõ†Ô∏è Menu Settings" 
ICON_APPS    = "üì± Applications"
ICON_RUN     = "üöÄ Run"
ICON_HOME    = "üè† HOME"
ICON_BACK    = "‚¨ÖÔ∏è BACK"
SEP_LINE     = "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
RUN_ITEM_ICON = "utilities-terminal" 

def load_json(path):
    if os.path.exists(path):
        try:
            with open(path, 'r') as f: return json.load(f)
        except: return {}
    return {}

def save_json(path, data):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, 'w') as f: json.dump(data, f, indent=2)

def get_system_apps():
    apps = {}
    paths = ["/usr/share/applications/*.desktop", os.path.expanduser("~/.local/share/applications/*.desktop")]
    for path_glob in paths:
        for entry in glob.glob(path_glob):
            try:
                with open(entry, 'r') as f:
                    name, cmd, icon = None, None, "system-run"
                    for line in f:
                        if line.startswith("Name=") and not name: name = line.split("=")[1].strip()
                        elif line.startswith("Exec=") and not cmd: cmd = line.split("=")[1].split('%')[0].strip()
                        elif line.startswith("Icon=") and icon == "system-run": icon = line.split("=")[1].strip()
                    if name and cmd: apps[name] = {"cmd": cmd, "icon": icon}
            except: continue
    return apps

def build_rofi_args(settings, filter_text=None):
    loc_val = {"top": 2, "bottom": 7, "left": 4, "right": 5, "center": 0}.get(settings.get("location", "center"), 0)
    width, lines = settings.get("width", 30), settings.get("height", 12)
    theme_str = f"window {{ width: {width}%; location: {settings.get('location', 'center')}; }} listview {{ lines: {lines}; columns: 1; }}"
    args = ["rofi", "-dmenu", "-i", "-show-icons", "-location", str(loc_val), "-theme-str", theme_str, "-kb-custom-1", "Alt+Return"]
    if filter_text: args += ["-filter", filter_text]
    return args

def main():
    config = load_json(CONFIG_PATH)
    state = load_json(STATE_PATH)
    settings = config.get("settings", {})
    menu_data = config.get("menu", {})
    weights = state.get("history", {})
    current_path = state.get("last_path", []) if settings.get("remember_last_path", True) else []
    
    while True:
        rofi_args = build_rofi_args(settings)
        in_run = len(current_path) > 0 and current_path[0] == ICON_RUN
        in_apps = len(current_path) > 0 and current_path[0] == ICON_APPS
        system_apps = get_system_apps()
        
        # Build current view
        if len(current_path) > 0 and current_path[0] == ICON_OPTIONS: 
            active_menu = {"üßπ Clear History": "INTERNAL:CLEAR_HIST", "üìù Edit Config": f"TERM:nvim {CONFIG_PATH}"}
        elif in_apps: active_menu = system_apps
        elif in_run:
            active_menu = {k.split("RUN:")[1]: k.split("RUN:")[1] for k in weights.keys() if k.startswith("RUN:")}
        else: active_menu = menu_data

        try:
            depth = 1 if (in_run or in_apps or (len(current_path) > 0 and current_path[0] == ICON_OPTIONS)) else 0
            for i in range(depth, len(current_path)): active_menu = active_menu[current_path[i]]
        except: current_path = []; active_menu = menu_data

        rofi_list = []
        options_dict = {}
        if not current_path:
            categories = list(menu_data.keys())
            categories.sort(key=lambda x: weights.get(f"HOME:{x}", 0), reverse=True)
            rofi_list.extend(categories + [ICON_RUN, ICON_APPS, ICON_OPTIONS, SEP_LINE])
            
            # Global items
            run_pool = {f"{k.split('RUN:')[1]}    ({ICON_RUN})": k.split('RUN:')[1] for k in weights.keys() if k.startswith("RUN:")}
            app_pool = {f"{n}    ({ICON_APPS})": d for n, d in system_apps.items()}
            
            combined_pool = {**app_pool, **run_pool}
            global_items = list(combined_pool.keys())
            global_items.sort(key=lambda x: weights.get(f"RUN:{x.split('    (')[0]}" if f"({ICON_RUN})" in x else f"APP:{x.split('    (')[0]}", 0), reverse=True)
            rofi_list.extend(global_items)
            options_dict = combined_pool
        else:
            rofi_list.append(ICON_BACK)
            items = list(active_menu.keys())
            if in_apps:
                items.sort(key=lambda x: weights.get(f"APP:{x}", 0), reverse=True)
                for item in items: rofi_list.append(f"{item}\0icon\x1f{active_menu[item].get('icon', 'system-run')}")
            else:
                items.sort(key=lambda x: weights.get(f"{' > '.join(current_path)}:{x}", 0), reverse=True)
                rofi_list.extend(items)

        prompt = f" {settings.get('prompt_icon', '‚ö°')} {' > '.join(current_path) if current_path else 'HUB'} "
        proc = subprocess.run(rofi_args + ["-p", prompt], input="\n".join(rofi_list), text=True, capture_output=True)
        choice, ret = proc.stdout.strip(), proc.returncode
        
        if not choice: break

        # --- SUB-MENU LOGIC (Triggered by Alt+Enter OR normal select on Run items) ---
        is_run_item = f"({ICON_RUN})" in choice or in_run
        
        if ret == 10 and is_run_item:
            clean_cmd = choice.split("    (")[0] if "    (" in choice else choice
            action_list = ["üöÄ Run Now", "üìù Edit & Run", "üóëÔ∏è Delete from History", ICON_BACK]
            sub_proc = subprocess.run(build_rofi_args(settings) + ["-p", f"Action: {clean_cmd}"], 
                                      input="\n".join(action_list), text=True, capture_output=True)
            action = sub_proc.stdout.strip()
            
            if action == "üöÄ Run Now":
                choice = clean_cmd
            elif action == "üìù Edit & Run":
                edit_proc = subprocess.run(build_rofi_args(settings, filter_text=clean_cmd) + ["-p", "Edit:"], 
                                           input="", text=True, capture_output=True)
                choice = edit_proc.stdout.strip()
                if not choice: continue
            elif action == "üóëÔ∏è Delete from History":
                keys_to_del = [k for k in weights if clean_cmd == k.split(":", 1)[-1]]
                for k in keys_to_del: weights.pop(k, None)
                save_json(STATE_PATH, {"last_path": current_path, "history": weights})
                continue
            else:
                continue

        # --- EXECUTION LOGIC ---
        if choice == ICON_BACK: current_path.pop()
        elif choice in [ICON_OPTIONS, ICON_APPS, ICON_RUN]: current_path = [choice]
        else:
            selection = options_dict.get(choice) if not current_path else active_menu.get(choice)
            if selection is None: selection = choice # For edited commands
            
            if isinstance(selection, dict) and "cmd" not in selection:
                current_path.append(choice)
            else:
                is_app = f"({ICON_APPS})" in choice or in_apps
                is_run = f"({ICON_RUN})" in choice or in_run or (selection == choice)
                label = choice.split("    (")[0] if (is_app or is_run) else choice
                cmd = selection["cmd"] if (is_app and isinstance(selection, dict)) else selection
                
                # Weighting
                w_key = f"RUN:{label}" if is_run else (f"APP:{label}" if is_app else f"HOME:{choice}")
                weights[w_key] = weights.get(w_key, 0) + 1
                
                if cmd == "INTERNAL:CLEAR_HIST":
                    state["history"] = {}; weights = {}; current_path = []
                else:
                    t = settings.get("terminal_emulator", "wezterm start --")
                    if cmd.startswith("TERM:"): cmd = f"{t} bash -c \"{cmd[5:]}; echo; read\""
                    elif cmd.startswith("EDT:"): cmd = f"{t} {settings.get('editor', 'nano')} {os.path.expanduser(cmd[4:])}"
                    elif cmd.startswith("WEB:"): cmd = f"xdg-open '{cmd[4:] if '://' in cmd[4:] else 'https://' + cmd[4:]}'"
                    subprocess.Popen(cmd, shell=True, start_new_session=True)
                    state["last_path"], state["history"] = (current_path, weights)
                    save_json(STATE_PATH, state); return

        state["last_path"], state["history"] = (current_path, weights)
        save_json(STATE_PATH, state)

if __name__ == "__main__":
    main()