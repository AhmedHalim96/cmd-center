#!/usr/bin/env python3
import subprocess, os, json, glob

# --- CONSTANTS & PATHS ---
BASE_DIR = os.path.expanduser("~/.config/cmd-center")
CONFIG_PATH = os.path.join(BASE_DIR, "config.json")
STATE_PATH = os.path.join(BASE_DIR, "state.json")

ICON_OPTIONS = "ðŸ› ï¸ Menu Settings" 
ICON_APPS    = "ðŸ“± Applications"
ICON_HOME    = "ðŸ  HOME"
ICON_BACK    = "â¬…ï¸ BACK"
SEP_LINE     = "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

INTERNAL_MENU = {
    "ðŸ§¹ Clear History": "INTERNAL:CLEAR_HIST",
    "ðŸ“ Edit Config": f"TERM:nvim {CONFIG_PATH}"
}

def load_json(path):
    if os.path.exists(path):
        with open(path, 'r') as f: return json.load(f)
    return {}

def save_json(path, data):
    os.makedirs(os.path.dirname(path), exist_ok=True)
    with open(path, 'w') as f: json.dump(data, f, indent=2)

def get_system_apps():
    """Scans .desktop files to find installed GUI applications."""
    apps = {}
    # Common locations for .desktop files
    paths = ["/usr/share/applications/*.desktop", os.path.expanduser("~/.local/share/applications/*.desktop")]
    for path_glob in paths:
        for entry in glob.glob(path_glob):
            try:
                with open(entry, 'r') as f:
                    name, cmd = None, None
                    for line in f:
                        if line.startswith("Name=") and not name:
                            name = line.split("=")[1].strip()
                        if line.startswith("Exec=") and not cmd:
                            cmd = line.split("=")[1].split('%')[0].strip() # Clean %u, %f etc
                        if name and cmd:
                            apps[name] = cmd
                            break
            except: continue
    return apps

def get_flat_menu(menu, prefix=""):
    flat = {}
    for key, value in menu.items():
        if isinstance(value, dict):
            new_prefix = f"{prefix} > {key}" if prefix else key
            flat.update(get_flat_menu(value, new_prefix))
        else:
            display_key = f"{key}    ({prefix})" if prefix else key
            flat[display_key] = value
    return flat

def build_rofi_args(settings):
    loc_map = {"top": 2, "bottom": 7, "left": 4, "right": 5, "center": 0, "top-left": 1, "top-right": 3, "bottom-left": 6, "bottom-right": 8}
    loc_val = loc_map.get(settings.get("location", "center"), 0)
    width, lines = settings.get("width", 30), settings.get("height", 12)
    theme_str = f"window {{ width: {width}%; location: {settings.get('location', 'center')}; x-offset: {settings.get('x_offset', 0)}; y-offset: {settings.get('y_offset', 0)}; }} listview {{ lines: {lines}; columns: 1; }}"
    args = ["rofi", "-dmenu", "-i", "-location", str(loc_val), "-theme-str", theme_str]
    theme_file = settings.get("theme_file", "")
    if theme_file and os.path.exists(os.path.expanduser(theme_file)):
        args += ["-theme", os.path.expanduser(theme_file)]
    return args

def main():
    config = load_json(CONFIG_PATH)
    state = load_json(STATE_PATH)
    settings = config.get("settings", {})
    menu_data = config.get("menu", {})
    
    current_path = state.get("last_path", []) if settings.get("remember_last_path", True) else []
    weights = state.get("history", {}) if settings.get("remember_history", True) else {}
    rofi_args = build_rofi_args(settings)

    while True:
        # 1. State check
        in_options = len(current_path) > 0 and current_path[0] == ICON_OPTIONS
        in_apps = len(current_path) > 0 and current_path[0] == ICON_APPS
        
        # 2. Resolve active menu
        if in_options:
            active_menu = INTERNAL_MENU
        elif in_apps:
            active_menu = get_system_apps()
        else:
            active_menu = menu_data
        
        try:
            # Only drill down if we aren't in the flat Apps or Options root
            start_depth = 1 if (in_options or in_apps) else 0
            for i in range(start_depth, len(current_path)):
                active_menu = active_menu[current_path[i]]
        except:
            current_path = []; active_menu = menu_data

        path_str = " > ".join(current_path)
        options_dict = {}

        if not current_path:
            # HOME SCREEN
            categories = list(menu_data.keys())
            if settings.get("remember_history", True):
                categories.sort(key=lambda x: weights.get(f"HOME:{x}", 0), reverse=True)
            
            flat_user = get_flat_menu(menu_data)
            # Add virtual folders to search pool
            for k, v in INTERNAL_MENU.items(): flat_user[f"{k}    ({ICON_OPTIONS})"] = v
            
            global_items = list(flat_user.keys())
            if settings.get("remember_history", True):
                global_items.sort(key=lambda x: weights.get(f"HOME:{x}", 0), reverse=True)
            
            # Pin Apps and Settings to the top section
            options = categories + [ICON_APPS, ICON_OPTIONS, SEP_LINE] + global_items
            options_dict = {**menu_data, **flat_user}
        else:
            # SUB-MENU view
            items = list(active_menu.keys())
            # Sort apps alphabetically, user items by weight
            if in_apps: items.sort()
            elif not in_options and settings.get("remember_history", True):
                items.sort(key=lambda x: weights.get(f"{path_str}:{x}", 0), reverse=True)
            
            options = [ICON_HOME, ICON_BACK] + items if len(current_path) >= 2 else [ICON_BACK] + items

        prompt = f" {settings.get('prompt_icon', 'âš¡')} {path_str if path_str else 'HUB'} "
        choice = subprocess.run(rofi_args + ["-p", prompt], input="\n".join(options), text=True, capture_output=True).stdout.strip()
        
        if not choice or choice == SEP_LINE:
            if not choice: break
            continue

        if choice == ICON_BACK: current_path.pop()
        elif choice == ICON_HOME: current_path = []
        elif choice in [ICON_OPTIONS, ICON_APPS]: current_path = [choice]
        else:
            selection = options_dict.get(choice) if not current_path else active_menu.get(choice)
            if selection is None: continue

            if isinstance(selection, dict):
                current_path.append(choice)
            else:
                # EXECUTION logic
                if not (in_options or in_apps) and settings.get("remember_history", True):
                    w_key = f"HOME:{choice}" if not current_path else f"{path_str}:{choice}"
                    weights[w_key] = weights.get(w_key, 0) + 1
                
                if selection == "INTERNAL:CLEAR_HIST":
                    state["history"] = {}; weights = {}; current_path = []
                else:
                    t, ed = settings.get("terminal_emulator", "wezterm start --"), settings.get("editor", "nano")
                    cmd = selection
                    # Formatting...
                    if cmd.startswith("TERM:"): cmd = f"{t} bash -c \"{cmd[5:]}; echo; read\""
                    elif cmd.startswith("EDT:"):
                        fp = os.path.expanduser(cmd[4:])
                        cmd = f"{t} {ed} {fp}" if ed in ["nano", "vim", "nvim"] else f"{ed} {fp}"
                    elif cmd.startswith("WEB:"):
                        url = cmd[4:] if "://" in cmd[4:] else f"https://{cmd[4:]}"
                        cmd = f"xdg-open '{url}'"
                    
                    subprocess.Popen(cmd, shell=True, start_new_session=True)
                    state["last_path"], state["history"] = (current_path, weights)
                    save_json(STATE_PATH, state); return

        state["last_path"], state["history"] = (current_path, weights)
        save_json(STATE_PATH, state)

if __name__ == "__main__":
    main()